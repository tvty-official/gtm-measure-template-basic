___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "TVTY - Measure - TV To Web - Basic",
  "categories": ["ANALYTICS", "ATTRIBUTION"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "TVTY - Measure - Basic Tag",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "TVTY Tag Measure TV To Web.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "advertiserId",
    "displayName": "Advertiser ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^[0-9]{12}$"
        ]
      }
    ],
    "help": "Advertiser ID is provided by the Customer Success Team"
  },
  {
    "type": "TEXT",
    "name": "step",
    "displayName": "step",
    "simpleValueType": true,
    "help": "(optional) Name of the step - should be defined with CS team",
    "defaultValue": "other"
  },
  {
    "type": "TEXT",
    "name": "uid",
    "displayName": "uid",
    "simpleValueType": true,
    "help": "(optional) User ID - should be hashed with a salt"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const queryPermission = require('queryPermission');
const createArgumentsQueue = require('createArgumentsQueue');
const setInWindow = require('setInWindow');
const injectScript = require('injectScript');
const encodeUriComponent = require('encodeUriComponent');

const advertiserId = data.advertiserId;
const step = data.step;
const uid = data.uid;

log('TVTY: GTM TPL Basic');
log('TVTY: advertiser_id ' + advertiserId);

if (queryPermission('access_globals', 'write', 'tvty') == false) {
  log('TVTY: Could not create tvty buffer.');
  data.gtmOnFailure();
}
if (queryPermission('access_globals', 'write', 'TVTYObj') == false) {
  log('TVTY: Could not define TVTYObj variable.');
  data.gtmOnFailure();
}

const tvty = createArgumentsQueue('tvty', 'tvty.cmd');
setInWindow('TVTYObj', 'tvty');


const url = 'https://u360.d-bi.fr/hmx' + encodeUriComponent(advertiserId) + '.js';
log('TVTY: Loading script ' + url);

if (queryPermission('inject_script', url)) {
  injectScript(url, data.gtmOnSuccess, data.gtmOnFailure, url);
  log('TVTY: Script loaded Successfully.');
} else {
  log('TVTY: Script load failed.');
  data.gtmOnFailure();
}

if (step !== undefined && step !== ''){
  log('TVTY: set step ' + step);
  tvty('set', 'step', step);
}

if (uid !== undefined && uid !== ''){
  log('TVTY: set uid ' + uid);
  tvty('set', 'uid', uid);
}

log('TVTY: triggger send');
tvty('send');
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "TVTYObj"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "tvty"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "tvty.cmd"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://u360.d-bi.fr/hmx*.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: demo send
  code: |-
    const mockData = {
      // Mocked field values
      advertiserId: '000000000582'
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: demo set_step
  code: |-
    const mockData = {
      advertiserId: '000000000582',
      step: 'my_step'
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: demo set uid
  code: |-
    const mockData = {
      advertiserId: '000000000582',
      step: 'my_step',
      uid: '0123456',
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: empty step uid
  code: |-
    const log = require('logToConsole');
    const mockData = {
      advertiserId: '000000000582',
      step: '',
      uid: '',
    };

    mock('sendPixel', (url, onSuccess, onFailure) => {
      log("-->" + url);
    });

    // Call runCode to run the template's code.
    let variableResult = runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 12/05/2021 à 06:20:50


